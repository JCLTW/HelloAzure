# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main
  
stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
    - job: Build
      displayName: Build
      pool:
        vmImage: ubuntu-latest
      steps:
      - task: Docker@2
        displayName: Build and push an image to container registry
        inputs:
          command: buildAndPush
          repository: 'helloazure'
          dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
          containerRegistry: azureContainerRegistryConnection # Service connection name
          tags: |
            $(tag)
      - task: AzureCLI@2
        displayName: "Helm Save & Push"
        inputs:
          azureSubscription: $(azureSubscription)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            appVersion="$(tag)"
            echo "App version: $appVersion"
            export HELM_EXPERIMENTAL_OCI=1
            echo $servicePrincipalKey | helm registry login $(acrUrl) --username $servicePrincipalId --password-stdin
            rm -rf *.tgz
            helm chart save $(helm package --app-version "$appVersion" --version $(helmTag) . | grep -o '/.*.tgz') $(acrUrl)/helm/$(helmRepoName)
            helm chart push $(acrUrl)/helm/$(helmRepoName):$(helmTag)
            helm chart remove $(acrUrl)/helm/$(helmRepoName):$(helmTag)
          addSpnToEnvironment: true
          workingDirectory: "helm/"